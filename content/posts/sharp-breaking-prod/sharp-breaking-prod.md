---
title: Sharp breaking prod
description: "Packaging lambda function failed with the error Command failed with exit code 1: npm install --no-bin-links --production."
date: 2022-10-04T11:00:00.000Z
---

I work a lot with AWS, I am not a pro but I can find my way around most things.

Recently, we introduced a requirement to compress images that are being stored on S3. For a "not-yet-launched" project, I was a bit against the idea but then I thought it would be a great challenge.

You see there are two ways to approach this problem.

1. Compress the images client-side and upload an already compressed image.
2. Compress the images server-side.

As a "cool" Web dev, I know how option 1 is wrong. When building for great experiences, the main idea is to do only the necessary thing on the client-side and most of the heavy lifting on the server-side. The user doesn't care whether you are compressing images or not, so you really don't have to do this client-side.

So server-side was the best bet, or rather "best practice". I am hacky, like my mind thinks in bits, not computer bits but "small things" bits. If you showed me a forest, I will think about the trees. In this case, that I what I did, I started thinking about the trees, the granular things that make together the solution.

Remember when I said I am not an AWS pro, yea, I am really not. For this, I though I should create an endpoint that would take an uncompressed image, compress it and return the result, which would ideally work. But AWS is too smart for this.

### Here comes S3 Triggers.

S3 triggers allows you to fire a lambda function when an action is performed on S3. In this case, the action would be "an image has been inserted", my lambda function would be triggered and then this lambda function would compress the image and save it again.

I know you are smart enough to notice an infinite loop here. If a lambda is triggered when an image is saved and this lambda saves an image, won't that trigger the lambda again? Yes it will. 

I will talk about S3 triggers in depth as it's own post.

Anyway, moving along.

### Sharp - the compresser of my images, the breaker of my prod

Sharp is a high performance Node.js image processing library. Of course I needed it to compress my images.

The main caveat it that Sharp is sort of platform agnostic yet it requires a specific binary installation for the platform it runs on. On my machine, Sharp will run on the Windows x86 platform, but on prod (AWS servers) it will be running on the Linux x64 platform.

Without putting this into consideration, the build step for the lambdas will throw an error:

```bash
[0mError: Packaging lambda function failed with the error [0m
                                 [0mCommand failed with exit code 1: npm install --no-bin-links --production[0m
                                 [0msh: prebuild-install: command not found[0m
                                 [0m../src/common.cc:24:10: fatal error: vips/vips8:  [0m
                                 [0m #include <vips/vips8>[0m
                                 [0m          ^~~~~~~~~~~~[0m
                                 [0mcompilation terminated.[0m
                                 [0mmake: *** [Release/obj.target/sharp-linux-x64/src/common.o] Error 1[0m
                                 [0mgyp ERR! build error [0m
```


Notice there is a line that has ``prebuild-install: command not found``. Yea, apparently, we need a prebuild-install to include binaries for the Linux x64 platform to the ``node_modules`` directory of the deployment package.

##### The solution
In the ``package.json`` of your lambda function, make sure you add a prebuild-install like so:

```json
{
  "name": "s3imagecompression",
  "version": "2.0.0",
  "description": "Lambda function generated by Amplify",
  "main": "index.js",
  "license": "Apache-2.0",
  "scripts": {
    "preinstall": "SHARP_IGNORE_GLOBAL_LIBVIPS=1 npm install --arch=x64 --platform=linux --libc=glibc sharp"
  },
  "dependencies": {
    "@types/aws-lambda": "^8.10.92",
    "aws-sdk": "^2.778.0",
    "sharp": "^0.31.0"
  }
}
```


And that's it. 

Push your code and watch Amplify go green


Cheers :)
